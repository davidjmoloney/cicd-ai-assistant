{
  "_debug_metadata": {
    "timestamp": "20260216_104614",
    "tool_id": "ruff",
    "signal_type": "lint",
    "num_signals": 4,
    "signal_files": [
      "ria/views.py",
      "ria/serializers.py",
      "authentication/admin.py"
    ],
    "system_prompt_length": 8600,
    "user_prompt_length": 10473
  },
  "context": {
    "group": {
      "tool_id": "ruff",
      "signal_type": "lint",
      "group_size": 4
    },
    "signals": [
      {
        "signal": {
          "tool_id": "ruff",
          "signal_type": "lint",
          "severity": "medium",
          "rule_code": "B904",
          "message": "Within an `except` clause, raise exceptions with `raise ... from err` or `raise ... from None` to distinguish them from errors in exception handling",
          "docs_url": "https://docs.astral.sh/ruff/rules/raise-without-from-inside-except",
          "file_path": "ria/views.py",
          "span": {
            "start": {
              "row": 695,
              "column": 13
            },
            "end": {
              "row": 695,
              "column": 92
            }
          }
        },
        "file_read_error": null,
        "code_context": {
          "window": {
            "file_path": "ria/views.py",
            "start_row": 665,
            "end_row": 695,
            "text": "            total_activities = len(records)\n            by_activity_type = {}\n            by_user = {}\n            \n            for record in records:\n                # Count by activity type\n                activity_type = record.get(\"activity_type\", \"unknown\")\n                by_activity_type[activity_type] = by_activity_type.get(activity_type, 0) + 1\n                \n                # Count by user\n                user_id = record.get(\"user_id\", \"unknown\")\n                by_user[user_id] = by_user.get(user_id, 0) + 1\n            \n            response_data = {\n                \"total_activities\": total_activities,\n                \"by_activity_type\": by_activity_type,\n                \"by_user\": by_user,\n                \"date_range\": {\n                    \"from_date\": from_date.isoformat() if from_date else None,\n                    \"to_date\": to_date.isoformat() if to_date else None\n                }\n            }\n            \n            response_serializer = RIAActivitySummaryResponseSerializer(data=response_data)\n            response_serializer.is_valid()\n            \n            return Response(response_serializer.data, status=status.HTTP_200_OK)\n            \n        except Exception as e:\n            logger.error(f\"Failed to generate RIA activity summary: {str(e)}\", exc_info=True)\n            raise APIException(detail=f\"Failed to generate RIA activity summary: {str(e)}\")\n"
          },
          "imports": {
            "file_path": "ria/views.py",
            "start_row": 1,
            "end_row": 26,
            "text": "\"\"\"\nDjango REST Framework views for RIA API.\n\nConverted from FastAPI routes in prospecting_api.py.\nAll views use class-based approach with Django async support.\n\"\"\"\n\nimport json\nimport io\nfrom datetime import datetime\nfrom typing import Dict, Any, Optional\n\nimport boto3\nimport polars as pl\nfrom botocore.exceptions import ClientError\nfrom django.http import StreamingHttpResponse, FileResponse\nfrom rest_framework.views import APIView\nfrom rest_framework.response import Response\nfrom rest_framework import status\nfrom rest_framework.permissions import IsAuthenticated\nfrom authentication.permissions import IsAdmin\nfrom rest_framework.exceptions import NotFound, PermissionDenied, ValidationError, APIException\nfrom rest_framework.request import Request\nfrom common.views import AsyncAPIView\n\nfrom ria.serializers import (\n"
          },
          "enclosing_function": {
            "file_path": "ria/views.py",
            "start_row": 642,
            "end_row": 695,
            "text": "    \n    async def get(self, request: Request):\n        \"\"\"Handle GET request for activity summary.\"\"\"\n        serializer = RIAActivitySummarySerializer(data=request.query_params)\n        serializer.is_valid(raise_exception=True)\n        \n        from_date = serializer.validated_data.get('from_date')\n        to_date = serializer.validated_data.get('to_date')\n        \n        logger.info(f\"Admin RIA activity summary request: from_date={from_date}, to_date={to_date}\")\n        \n        try:\n            # Get all activities for summary calculation\n            all_activities = await QueryService.get_ria_activity(\n                from_date=from_date,\n                to_date=to_date,\n                limit=10000,  # Large limit for summary\n                offset=0\n            )\n            \n            records = all_activities[\"records\"]\n            \n            # Calculate summary statistics\n            total_activities = len(records)\n            by_activity_type = {}\n            by_user = {}\n            \n            for record in records:\n                # Count by activity type\n                activity_type = record.get(\"activity_type\", \"unknown\")\n                by_activity_type[activity_type] = by_activity_type.get(activity_type, 0) + 1\n                \n                # Count by user\n                user_id = record.get(\"user_id\", \"unknown\")\n                by_user[user_id] = by_user.get(user_id, 0) + 1\n            \n            response_data = {\n                \"total_activities\": total_activities,\n                \"by_activity_type\": by_activity_type,\n                \"by_user\": by_user,\n                \"date_range\": {\n                    \"from_date\": from_date.isoformat() if from_date else None,\n                    \"to_date\": to_date.isoformat() if to_date else None\n                }\n            }\n            \n            response_serializer = RIAActivitySummaryResponseSerializer(data=response_data)\n            response_serializer.is_valid()\n            \n            return Response(response_serializer.data, status=status.HTTP_200_OK)\n            \n        except Exception as e:\n            logger.error(f\"Failed to generate RIA activity summary: {str(e)}\", exc_info=True)\n            raise APIException(detail=f\"Failed to generate RIA activity summary: {str(e)}\")\n"
          },
          "try_except_block": null,
          "class_definition": null,
          "type_aliases": null,
          "related_function": null,
          "module_constants": null
        },
        "edit_snippet": {
          "file_path": "ria/views.py",
          "start_row": 688,
          "end_row": 695,
          "text": "    response_serializer = RIAActivitySummaryResponseSerializer(data=response_data)\n    response_serializer.is_valid()\n            \n    return Response(response_serializer.data, status=status.HTTP_200_OK)\n            \nexcept Exception as e:\n    logger.error(f\"Failed to generate RIA activity summary: {str(e)}\", exc_info=True)\n    raise APIException(detail=f\"Failed to generate RIA activity summary: {str(e)}\")\n",
          "original_text": "            response_serializer = RIAActivitySummaryResponseSerializer(data=response_data)\n            response_serializer.is_valid()\n            \n            return Response(response_serializer.data, status=status.HTTP_200_OK)\n            \n        except Exception as e:\n            logger.error(f\"Failed to generate RIA activity summary: {str(e)}\", exc_info=True)\n            raise APIException(detail=f\"Failed to generate RIA activity summary: {str(e)}\")\n",
          "error_line": 695,
          "error_line_in_snippet": 8,
          "snippet_length": 8,
          "base_indent": "        "
        },
        "edit_window_type": "lines",
        "fix_context": {
          "exists": false
        }
      },
      {
        "signal": {
          "tool_id": "ruff",
          "signal_type": "lint",
          "severity": "low",
          "rule_code": "I001",
          "message": "Import block is un-sorted or un-formatted",
          "docs_url": "https://docs.astral.sh/ruff/rules/unsorted-imports",
          "file_path": "authentication/admin.py",
          "span": {
            "start": {
              "row": 1,
              "column": 1
            },
            "end": {
              "row": 3,
              "column": 38
            }
          }
        },
        "file_read_error": null,
        "code_context": {
          "window": {
            "file_path": "authentication/admin.py",
            "start_row": 1,
            "end_row": 33,
            "text": "from django.contrib import admin\nfrom django.contrib.auth.admin import UserAdmin as BaseUserAdmin\nfrom .models import User, UserProfile\n\n\nclass UserProfileInline(admin.StackedInline):\n    model = UserProfile\n    can_delete = False\n    verbose_name_plural = 'Profile Details'\n    fields = ('firm_description', 'key_differentiators', 'key_objectives', \n              'investor_profile', 'first_name', 'last_name',\n              'created_at', 'updated_at')\n    readonly_fields = ('created_at', 'updated_at')\n    extra = 0\n    classes = ('collapse',)\n\n\n@admin.register(User)\nclass UserAdmin(BaseUserAdmin):\n    inlines = (UserProfileInline,)\n    list_display = ('email', 'firm_name', 'first_name', 'last_name', 'is_admin', \n                   'registration_status', 'is_active', 'date_joined')\n    list_filter = ('is_superuser', 'registration_status', 'is_active')\n    search_fields = ('email', 'firm_name', 'first_name', 'last_name')\n    ordering = ('-date_joined',)\n    date_hierarchy = 'date_joined'\n    \n    fieldsets = BaseUserAdmin.fieldsets + (\n        ('Ardessa Fields', {\n            'fields': ('user_id', 'firm_name', 'city', 'country', 'is_admin', \n                      'registration_status', 'daily_agent_run_limit', \n                      'tamradar_radar_limit', 'claims_snapshot', 'last_synced_at')\n        }),\n"
          },
          "imports": {
            "file_path": "authentication/admin.py",
            "start_row": 1,
            "end_row": 5,
            "text": "from django.contrib import admin\nfrom django.contrib.auth.admin import UserAdmin as BaseUserAdmin\nfrom .models import User, UserProfile\n\n\n"
          },
          "enclosing_function": null,
          "try_except_block": null,
          "class_definition": null,
          "type_aliases": null,
          "related_function": null,
          "module_constants": null
        },
        "edit_snippet": {
          "file_path": "authentication/admin.py",
          "start_row": 1,
          "end_row": 5,
          "text": "from django.contrib import admin\nfrom django.contrib.auth.admin import UserAdmin as BaseUserAdmin\nfrom .models import User, UserProfile\n\n\n",
          "original_text": "from django.contrib import admin\nfrom django.contrib.auth.admin import UserAdmin as BaseUserAdmin\nfrom .models import User, UserProfile\n\n\n",
          "error_line": 1,
          "error_line_in_snippet": 1,
          "snippet_length": 5,
          "base_indent": ""
        },
        "edit_window_type": "imports",
        "fix_context": {
          "exists": true,
          "applicability": "safe",
          "tool_message": "Organize imports",
          "edits": [
            {
              "span": {
                "start": {
                  "row": 1,
                  "column": 1
                },
                "end": {
                  "row": 6,
                  "column": 1
                }
              },
              "content": "from django.contrib import admin\nfrom django.contrib.auth.admin import UserAdmin as BaseUserAdmin\n\nfrom .models import User, UserProfile\n\n\n"
            }
          ]
        }
      },
      {
        "signal": {
          "tool_id": "ruff",
          "signal_type": "lint",
          "severity": "low",
          "rule_code": "I001",
          "message": "Import block is un-sorted or un-formatted",
          "docs_url": "https://docs.astral.sh/ruff/rules/unsorted-imports",
          "file_path": "ria/serializers.py",
          "span": {
            "start": {
              "row": 7,
              "column": 1
            },
            "end": {
              "row": 8,
              "column": 45
            }
          }
        },
        "file_read_error": null,
        "code_context": {
          "window": {
            "file_path": "ria/serializers.py",
            "start_row": 1,
            "end_row": 38,
            "text": "\"\"\"\nDjango REST Framework serializers for RIA API.\n\nThis module contains all request and response serializers for RIA endpoints.\n\"\"\"\n\nfrom rest_framework import serializers\nfrom typing import List, Dict, Any, Optional\n\n\n# ============================================================================\n# Request Serializers\n# ============================================================================\n\nclass RIAIndexSearchSerializer(serializers.Serializer):\n    \"\"\"Serializer for /ria/index query parameters.\"\"\"\n    state = serializers.CharField(\n        required=False, \n        allow_null=True, \n        allow_blank=True,\n        help_text=\"Exact match for Main Office State\"\n    )\n    name = serializers.CharField(\n        required=False, \n        allow_null=True, \n        allow_blank=True,\n        help_text=\"Exact match for Primary Business Name\"\n    )\n    min_5f_2c = serializers.FloatField(\n        required=False, \n        allow_null=True,\n        help_text=\"Minimum value for column 5F(2)(c)\"\n    )\n    limit = serializers.IntegerField(\n        default=100, \n        min_value=1, \n        max_value=100,\n        help_text=\"Number of results to return (1-100)\"\n"
          },
          "imports": {
            "file_path": "ria/serializers.py",
            "start_row": 1,
            "end_row": 14,
            "text": "\"\"\"\nDjango REST Framework serializers for RIA API.\n\nThis module contains all request and response serializers for RIA endpoints.\n\"\"\"\n\nfrom rest_framework import serializers\nfrom typing import List, Dict, Any, Optional\n\n\n# ============================================================================\n# Request Serializers\n# ============================================================================\n\n"
          },
          "enclosing_function": null,
          "try_except_block": null,
          "class_definition": null,
          "type_aliases": null,
          "related_function": null,
          "module_constants": null
        },
        "edit_snippet": {
          "file_path": "ria/serializers.py",
          "start_row": 1,
          "end_row": 14,
          "text": "\"\"\"\nDjango REST Framework serializers for RIA API.\n\nThis module contains all request and response serializers for RIA endpoints.\n\"\"\"\n\nfrom rest_framework import serializers\nfrom typing import List, Dict, Any, Optional\n\n\n# ============================================================================\n# Request Serializers\n# ============================================================================\n\n",
          "original_text": "\"\"\"\nDjango REST Framework serializers for RIA API.\n\nThis module contains all request and response serializers for RIA endpoints.\n\"\"\"\n\nfrom rest_framework import serializers\nfrom typing import List, Dict, Any, Optional\n\n\n# ============================================================================\n# Request Serializers\n# ============================================================================\n\n",
          "error_line": 7,
          "error_line_in_snippet": 7,
          "snippet_length": 14,
          "base_indent": ""
        },
        "edit_window_type": "imports",
        "fix_context": {
          "exists": true,
          "applicability": "safe",
          "tool_message": "Organize imports",
          "edits": [
            {
              "span": {
                "start": {
                  "row": 7,
                  "column": 1
                },
                "end": {
                  "row": 11,
                  "column": 1
                }
              },
              "content": "from typing import Any, Dict, List, Optional\n\nfrom rest_framework import serializers\n\n"
            }
          ]
        }
      },
      {
        "signal": {
          "tool_id": "ruff",
          "signal_type": "lint",
          "severity": "low",
          "rule_code": "UP035",
          "message": "`typing.List` is deprecated, use `list` instead",
          "docs_url": "https://docs.astral.sh/ruff/rules/deprecated-import",
          "file_path": "ria/serializers.py",
          "span": {
            "start": {
              "row": 8,
              "column": 1
            },
            "end": {
              "row": 8,
              "column": 45
            }
          }
        },
        "file_read_error": null,
        "code_context": {
          "window": {
            "file_path": "ria/serializers.py",
            "start_row": 1,
            "end_row": 38,
            "text": "\"\"\"\nDjango REST Framework serializers for RIA API.\n\nThis module contains all request and response serializers for RIA endpoints.\n\"\"\"\n\nfrom rest_framework import serializers\nfrom typing import List, Dict, Any, Optional\n\n\n# ============================================================================\n# Request Serializers\n# ============================================================================\n\nclass RIAIndexSearchSerializer(serializers.Serializer):\n    \"\"\"Serializer for /ria/index query parameters.\"\"\"\n    state = serializers.CharField(\n        required=False, \n        allow_null=True, \n        allow_blank=True,\n        help_text=\"Exact match for Main Office State\"\n    )\n    name = serializers.CharField(\n        required=False, \n        allow_null=True, \n        allow_blank=True,\n        help_text=\"Exact match for Primary Business Name\"\n    )\n    min_5f_2c = serializers.FloatField(\n        required=False, \n        allow_null=True,\n        help_text=\"Minimum value for column 5F(2)(c)\"\n    )\n    limit = serializers.IntegerField(\n        default=100, \n        min_value=1, \n        max_value=100,\n        help_text=\"Number of results to return (1-100)\"\n"
          },
          "imports": {
            "file_path": "ria/serializers.py",
            "start_row": 1,
            "end_row": 14,
            "text": "\"\"\"\nDjango REST Framework serializers for RIA API.\n\nThis module contains all request and response serializers for RIA endpoints.\n\"\"\"\n\nfrom rest_framework import serializers\nfrom typing import List, Dict, Any, Optional\n\n\n# ============================================================================\n# Request Serializers\n# ============================================================================\n\n"
          },
          "enclosing_function": null,
          "try_except_block": null,
          "class_definition": null,
          "type_aliases": null,
          "related_function": null,
          "module_constants": null
        },
        "edit_snippet": {
          "file_path": "ria/serializers.py",
          "start_row": 6,
          "end_row": 10,
          "text": "\nfrom rest_framework import serializers\nfrom typing import List, Dict, Any, Optional\n\n\n",
          "original_text": "\nfrom rest_framework import serializers\nfrom typing import List, Dict, Any, Optional\n\n\n",
          "error_line": 8,
          "error_line_in_snippet": 3,
          "snippet_length": 5,
          "base_indent": ""
        },
        "edit_window_type": "lines",
        "fix_context": {
          "exists": false
        }
      }
    ],
    "merged_snippet_groups": [
      {
        "signal_indices": [
          2,
          3
        ],
        "edit_snippet": {
          "file_path": "ria/serializers.py",
          "start_row": 1,
          "end_row": 14,
          "text": "\"\"\"\nDjango REST Framework serializers for RIA API.\n\nThis module contains all request and response serializers for RIA endpoints.\n\"\"\"\n\nfrom rest_framework import serializers\nfrom typing import List, Dict, Any, Optional\n\n\n# ============================================================================\n# Request Serializers\n# ============================================================================\n\n",
          "original_text": "\"\"\"\nDjango REST Framework serializers for RIA API.\n\nThis module contains all request and response serializers for RIA endpoints.\n\"\"\"\n\nfrom rest_framework import serializers\nfrom typing import List, Dict, Any, Optional\n\n\n# ============================================================================\n# Request Serializers\n# ============================================================================\n\n",
          "error_line": 7,
          "error_line_in_snippet": 7,
          "snippet_length": 14,
          "base_indent": ""
        }
      }
    ],
    "standalone_signal_indices": [
      0,
      1
    ]
  },
  "prompts": {
    "system_prompt": "You are an expert code repair agent. Your task is to make MINIMAL, SURGICAL fixes to code errors.\n\n## CRITICAL PRINCIPLE: MINIMAL CHANGES ONLY\n\nYour job is to fix ONLY the specific error mentioned. You are NOT improving, refactoring, or cleaning up code.\n\n**THE GOLDEN RULE**: Every line in your output that is NOT directly part of the fix MUST be IDENTICAL to the input - same content, same whitespace, same everything.\n\n## How This Works\n\nFor each error signal, you will receive:\n\n1. **Error Information**: Type, message, severity, and rule code\n2. **Edit Snippet**: A small code snippet (~13 lines) containing the error\n   - This is what you need to FIX and RETURN\n   - The error location within the snippet is indicated (e.g., \"Error on line 4 of 13\")\n3. **Context Window**: A larger code window (~30 lines) around the error for understanding\n   - Use this to understand the surrounding code, but DON'T return it\n\n4. **Tailored Context** (varies by signal type - optimized to reduce token usage):\n   - **Imports**: The file's import block (for type definitions, dependencies)\n     - Included for: type errors, undefined names, most issues\n     - Excluded for: import-only errors, bare except blocks\n   - **Enclosing Function**: The function containing the error (for understanding scope/logic)\n     - Included for: type errors, docstring errors, function-level issues\n     - Excluded for: import errors (global scope), bare except (sent separately)\n   - **Try/Except Block**: The try/except block containing the error\n     - Included for: bare except errors (E722)\n     - Excluded for: most other errors\n\nNote: Context is carefully selected to provide what you need while minimizing token usage.\nNot all context is present for every error - you'll only receive relevant context.\n\n## Response Format\n\nFor EACH signal/snippet you receive, respond with this EXACT format:\n\n```\n===== FIX FOR: <file_path> =====\nCONFIDENCE: <0.0-1.0>\nREASONING: <brief explanation of the fix>\n\n```FIXED_CODE\n<complete fixed snippet - ALL lines from edit_snippet, with ONLY the fix applied>\n```\n\nWARNINGS: <any caveats, or \"None\">\n===== END FIX =====\n```\n\n## CRITICAL Rules - READ CAREFULLY\n\n1. **MINIMAL CHANGES ONLY** - Change ONLY what is necessary to fix the specific error. Nothing more.\n\n2. **PRESERVE EVERYTHING ELSE EXACTLY** - Every line that is NOT part of the fix must be returned EXACTLY as it appeared in the input, character-for-character, including:\n   - Comments and documentation\n   - Blank lines (including leading and trailing blank lines)\n   - All whitespace (including trailing newlines at the end of the snippet)\n   - Other variable declarations\n   - Function definitions\n   - String content (including multi-line strings)\n\n   **CRITICAL**: If the input snippet ends with blank lines or newlines, your output MUST end with the exact same number of blank lines/newlines. Do NOT trim trailing whitespace.\n\n3. **DO NOT under any circumstances**:\n   - Delete lines that aren't related to the fix\n   - Add code that isn't required for the fix\n   - \"Clean up\" or \"improve\" surrounding code\n   - Modify comments or documentation\n   - Change formatting on unrelated lines\n   - Remove blank lines\n   - Add blank lines (unless the fix specifically requires it)\n   - Modify string literals or docstrings\n   - Delete function definitions\n   - Remove dictionary entries or list items unrelated to the fix\n\n4. **Maintain RELATIVE indentation** - The snippet has had its base indentation removed. Preserve relative indentation exactly. If a line has 4 spaces in the input, it must have 4 spaces in your output.\n\n5. **One fix block per signal** - If multiple signals, provide multiple fix blocks\n\n6. **Use context for understanding only** - The context window, imports, and enclosing function help you understand the code, but you only return the fixed edit_snippet\n\n## Example - Correct Minimal Fix\n\nInput:\n- Error: \"Need type annotation for 'cache'\" on line 173\n- Edit Snippet (error on line 4 of 7, lines 170-176):\n```\n}\n\nDEPRIORITIZE_QUERIES = {}\ncache = {}\n\n# Model configuration\nEMBEDDING_MODEL = \"text-embedding-3-large\"\n```\n(Note: The snippet ends with a newline after the last line - this MUST be preserved)\n\nCORRECT Response (only `cache = {}` changed to `cache: dict = {}`):\n```\n===== FIX FOR: app/config/tier_queries.py =====\nCONFIDENCE: 0.95\nREASONING: Added dict type annotation to cache variable to satisfy mypy\n\n```FIXED_CODE\n}\n\nDEPRIORITIZE_QUERIES = {}\ncache: dict = {}\n\n# Model configuration\nEMBEDDING_MODEL = \"text-embedding-3-large\"\n```\n\nWARNINGS: None\n===== END FIX =====\n```\n(Note: The output preserves the exact same trailing newline as the input)\n\n## Example - Preserving Trailing Whitespace\n\nInput snippet ending with blank lines (note the TWO newlines after the return statement):\n```\ndef get_clerk_settings() -> ClerkSettings:\n    # Load Clerk token validation settings from config helpers\n    return ClerkSettings.from_config()\n\n\n```\n\nCORRECT - Preserves both trailing newlines:\n```FIXED_CODE\ndef get_clerk_settings() -> ClerkSettings:\n    # Load Clerk token validation settings from config helpers\n    return ClerkSettings.from_config()\n\n\n```\n(Output MUST have the same TWO trailing newlines)\n\nWRONG - Trimming trailing newlines:\n```FIXED_CODE\ndef get_clerk_settings() -> ClerkSettings:\n    # Load Clerk token validation settings from config helpers\n    return ClerkSettings.from_config()\n```\n^ This is WRONG because it removed trailing newlines. The snippet MUST end with the same whitespace as the input.\n\n## Example - WRONG (Deleting Unrelated Content)\n\nIf the input snippet contains documentation or other code, you MUST preserve it:\n\nWRONG - Deleting unrelated lines:\n```FIXED_CODE\ncache: dict = {}\nEMBEDDING_MODEL = \"text-embedding-3-large\"\n```\n^ This is WRONG because it deleted the closing brace, blank lines, DEPRIORITIZE_QUERIES, and the comment.\n\n## Confidence Guidelines\n- High (>0.8): Simple fixes like type annotations, obvious corrections\n- Medium (0.5-0.8): Logic changes, type guards, refactoring\n- Low (<0.5): Complex changes, unclear intent - add detailed warnings\n\n\n\n## Ruff Lint Error Fixing - Specialized Guidance\n\nYou are fixing LINTING errors from Ruff. These are code quality, style, and\nbest practice issues - NOT security or type correctness.\n\nRisk Level: LOW to MEDIUM\nThese fixes should improve code quality without changing behavior.\n\nCommon Ruff Rule Categories:\n\nF (Pyflakes):\n- Unused imports/variables\n- Undefined names\n- Duplicate arguments\n- Invalid format strings\n\nE/W (pycodestyle):\n- Line length (E501)\n- Whitespace issues (E203, W291)\n- Indentation (E111, E114)\n- Blank lines (E302, E303)\n\nC (McCabe):\n- Complexity warnings (C901)\n- Too many branches/statements\n\nN (pep8-naming):\n- Naming conventions (N801-N818)\n- Lowercase function names\n- CamelCase class names\n\nI (isort):\n- Import sorting/organization\n\nUP (pyupgrade):\n- Outdated syntax\n- Type hint modernization\n\nFixing Strategies:\n\n1. **Remove Unused Code** - But verify it's truly unused\n   \u2705 Remove unused imports\n   \u2705 Remove unused variables\n   \u26a0\ufe0f Check for side effects first!\n\n2. **Simplify Logic** - Follow Python idioms\n   \u2705 `if x == True:` \u2192 `if x:`\n   \u2705 `if len(list) > 0:` \u2192 `if list:`\n   \u2705 Use comprehensions instead of loops\n\n3. **Fix Naming** - Follow PEP 8\n   \u2705 `MyFunction` \u2192 `my_function`\n   \u2705 `my_class` \u2192 `MyClass`\n\n4. **Modernize Syntax** - Use newer Python features\n   \u2705 `Union[str, int]` \u2192 `str | int` (Python 3.10+)\n   \u2705 `Optional[str]` \u2192 `str | None` (Python 3.10+)\n\n5. **Organize Imports** - Sort and group properly\n   \u2705 Standard library first\n   \u2705 Third-party second\n   \u2705 Local imports last\n\nNEVER do these:\n\u274c Remove code that has side effects (initializers, registrations)\n\u274c Change behavior to fix style\n\u274c Break working code to satisfy complexity metrics\n\u274c Remove \"unused\" variables that are part of unpacking\n\nSpecial Cases:\n\nComplexity Warnings (C901):\n- Don't just suppress with # noqa\n- Consider refactoring if genuinely complex\n- But set confidence < 0.7 for refactoring suggestions\n\nUnused Variables:\n- `x, y, z = tuple` - y might be \"unused\" but needed for unpacking\n- Consider renaming to `_` if truly unused: `x, _, z = tuple`\n\nLine Length (E501):\n- Can often be fixed by breaking long lines\n- But some URLs or strings are legitimately long\n- Use # noqa: E501 with comment explaining why\n\nConfidence Guidelines:\n- High (>0.8): Remove unused imports, fix obvious naming\n- Medium (0.5-0.8): Simplify logic, organize imports\n- Low (<0.5): Refactoring suggestions, complex changes\n\nRemember: Preserve behavior. These are style improvements, not bug fixes.\n",
    "user_prompt": "Tool: ruff\nSignal Type: lint\nNumber of Signals: 4\n\n============================================================\nSIGNAL 1\n============================================================\n\n## Error Information\n- File: ria/views.py\n- Message: Within an `except` clause, raise exceptions with `raise ... from err` or `raise ... from None` to distinguish them from errors in exception handling\n- Rule Code: B904\n- Severity: medium\n- Location: Line 695, Column 13\n\n## Edit Snippet (FIX AND RETURN THIS)\nLines 688-695 (error on line 8 of 8)\n```python\n    response_serializer = RIAActivitySummaryResponseSerializer(data=response_data)\n    response_serializer.is_valid()\n            \n    return Response(response_serializer.data, status=status.HTTP_200_OK)\n            \nexcept Exception as e:\n    logger.error(f\"Failed to generate RIA activity summary: {str(e)}\", exc_info=True)\n    raise APIException(detail=f\"Failed to generate RIA activity summary: {str(e)}\")\n\n```\n\n## Context Window (for understanding, DO NOT return)\nLines 665-695\n```python\n            total_activities = len(records)\n            by_activity_type = {}\n            by_user = {}\n            \n            for record in records:\n                # Count by activity type\n                activity_type = record.get(\"activity_type\", \"unknown\")\n                by_activity_type[activity_type] = by_activity_type.get(activity_type, 0) + 1\n                \n                # Count by user\n                user_id = record.get(\"user_id\", \"unknown\")\n                by_user[user_id] = by_user.get(user_id, 0) + 1\n            \n            response_data = {\n                \"total_activities\": total_activities,\n                \"by_activity_type\": by_activity_type,\n                \"by_user\": by_user,\n                \"date_range\": {\n                    \"from_date\": from_date.isoformat() if from_date else None,\n                    \"to_date\": to_date.isoformat() if to_date else None\n                }\n            }\n            \n            response_serializer = RIAActivitySummaryResponseSerializer(data=response_data)\n            response_serializer.is_valid()\n            \n            return Response(response_serializer.data, status=status.HTTP_200_OK)\n            \n        except Exception as e:\n            logger.error(f\"Failed to generate RIA activity summary: {str(e)}\", exc_info=True)\n            raise APIException(detail=f\"Failed to generate RIA activity summary: {str(e)}\")\n\n```\n\n## Imports\n```python\n\"\"\"\nDjango REST Framework views for RIA API.\n\nConverted from FastAPI routes in prospecting_api.py.\nAll views use class-based approach with Django async support.\n\"\"\"\n\nimport json\nimport io\nfrom datetime import datetime\nfrom typing import Dict, Any, Optional\n\nimport boto3\nimport polars as pl\nfrom botocore.exceptions import ClientError\nfrom django.http import StreamingHttpResponse, FileResponse\nfrom rest_framework.views import APIView\nfrom rest_framework.response import Response\nfrom rest_framework import status\nfrom rest_framework.permissions import IsAuthenticated\nfrom authentication.permissions import IsAdmin\nfrom rest_framework.exceptions import NotFound, PermissionDenied, ValidationError, APIException\nfrom rest_framework.request import Request\nfrom common.views import AsyncAPIView\n\nfrom ria.serializers import (\n\n```\n\n## Enclosing Function\nLines 642-695\n```python\n    \n    async def get(self, request: Request):\n        \"\"\"Handle GET request for activity summary.\"\"\"\n        serializer = RIAActivitySummarySerializer(data=request.query_params)\n        serializer.is_valid(raise_exception=True)\n        \n        from_date = serializer.validated_data.get('from_date')\n        to_date = serializer.validated_data.get('to_date')\n        \n        logger.info(f\"Admin RIA activity summary request: from_date={from_date}, to_date={to_date}\")\n        \n        try:\n            # Get all activities for summary calculation\n            all_activities = await QueryService.get_ria_activity(\n                from_date=from_date,\n                to_date=to_date,\n                limit=10000,  # Large limit for summary\n                offset=0\n            )\n            \n            records = all_activities[\"records\"]\n            \n            # Calculate summary statistics\n            total_activities = len(records)\n            by_activity_type = {}\n            by_user = {}\n            \n            for record in records:\n                # Count by activity type\n                activity_type = record.get(\"activity_type\", \"unknown\")\n                by_activity_type[activity_type] = by_activity_type.get(activity_type, 0) + 1\n                \n                # Count by user\n                user_id = record.get(\"user_id\", \"unknown\")\n                by_user[user_id] = by_user.get(user_id, 0) + 1\n            \n            response_data = {\n                \"total_activities\": total_activities,\n                \"by_activity_type\": by_activity_type,\n                \"by_user\": by_user,\n                \"date_range\": {\n                    \"from_date\": from_date.isoformat() if from_date else None,\n                    \"to_date\": to_date.isoformat() if to_date else None\n                }\n            }\n            \n            response_serializer = RIAActivitySummaryResponseSerializer(data=response_data)\n            response_serializer.is_valid()\n            \n            return Response(response_serializer.data, status=status.HTTP_200_OK)\n            \n        except Exception as e:\n            logger.error(f\"Failed to generate RIA activity summary: {str(e)}\", exc_info=True)\n            raise APIException(detail=f\"Failed to generate RIA activity summary: {str(e)}\")\n\n```\n\n\n============================================================\nSIGNAL 2\n============================================================\n\n## Error Information\n- File: authentication/admin.py\n- Message: Import block is un-sorted or un-formatted\n- Rule Code: I001\n- Severity: low\n- Location: Line 1, Column 1\n\n## Edit Snippet (FIX AND RETURN THIS)\nLines 1-5 (error on line 1 of 5)\n```python\nfrom django.contrib import admin\nfrom django.contrib.auth.admin import UserAdmin as BaseUserAdmin\nfrom .models import User, UserProfile\n\n\n\n```\n\n## Context Window (for understanding, DO NOT return)\nLines 1-33\n```python\nfrom django.contrib import admin\nfrom django.contrib.auth.admin import UserAdmin as BaseUserAdmin\nfrom .models import User, UserProfile\n\n\nclass UserProfileInline(admin.StackedInline):\n    model = UserProfile\n    can_delete = False\n    verbose_name_plural = 'Profile Details'\n    fields = ('firm_description', 'key_differentiators', 'key_objectives', \n              'investor_profile', 'first_name', 'last_name',\n              'created_at', 'updated_at')\n    readonly_fields = ('created_at', 'updated_at')\n    extra = 0\n    classes = ('collapse',)\n\n\n@admin.register(User)\nclass UserAdmin(BaseUserAdmin):\n    inlines = (UserProfileInline,)\n    list_display = ('email', 'firm_name', 'first_name', 'last_name', 'is_admin', \n                   'registration_status', 'is_active', 'date_joined')\n    list_filter = ('is_superuser', 'registration_status', 'is_active')\n    search_fields = ('email', 'firm_name', 'first_name', 'last_name')\n    ordering = ('-date_joined',)\n    date_hierarchy = 'date_joined'\n    \n    fieldsets = BaseUserAdmin.fieldsets + (\n        ('Ardessa Fields', {\n            'fields': ('user_id', 'firm_name', 'city', 'country', 'is_admin', \n                      'registration_status', 'daily_agent_run_limit', \n                      'tamradar_radar_limit', 'claims_snapshot', 'last_synced_at')\n        }),\n\n```\n\n## Imports\n```python\nfrom django.contrib import admin\nfrom django.contrib.auth.admin import UserAdmin as BaseUserAdmin\nfrom .models import User, UserProfile\n\n\n\n```\n\n\n============================================================\nSIGNALS 3-4 (shared edit region)\n============================================================\n\n## Error 1\n- File: ria/serializers.py\n- Message: Import block is un-sorted or un-formatted\n- Rule Code: I001\n- Severity: low\n- Location: Line 7, Column 1\n\n## Error 2\n- File: ria/serializers.py\n- Message: `typing.List` is deprecated, use `list` instead\n- Rule Code: UP035\n- Severity: low\n- Location: Line 8, Column 1\n\n## Edit Snippet (FIX ALL ERRORS ABOVE AND RETURN THIS)\nLines 1-14 (2 errors in 14 lines)\n```python\n\"\"\"\nDjango REST Framework serializers for RIA API.\n\nThis module contains all request and response serializers for RIA endpoints.\n\"\"\"\n\nfrom rest_framework import serializers\nfrom typing import List, Dict, Any, Optional\n\n\n# ============================================================================\n# Request Serializers\n# ============================================================================\n\n\n```\n\n## Context Window (for understanding, DO NOT return)\nLines 1-38\n```python\n\"\"\"\nDjango REST Framework serializers for RIA API.\n\nThis module contains all request and response serializers for RIA endpoints.\n\"\"\"\n\nfrom rest_framework import serializers\nfrom typing import List, Dict, Any, Optional\n\n\n# ============================================================================\n# Request Serializers\n# ============================================================================\n\nclass RIAIndexSearchSerializer(serializers.Serializer):\n    \"\"\"Serializer for /ria/index query parameters.\"\"\"\n    state = serializers.CharField(\n        required=False, \n        allow_null=True, \n        allow_blank=True,\n        help_text=\"Exact match for Main Office State\"\n    )\n    name = serializers.CharField(\n        required=False, \n        allow_null=True, \n        allow_blank=True,\n        help_text=\"Exact match for Primary Business Name\"\n    )\n    min_5f_2c = serializers.FloatField(\n        required=False, \n        allow_null=True,\n        help_text=\"Minimum value for column 5F(2)(c)\"\n    )\n    limit = serializers.IntegerField(\n        default=100, \n        min_value=1, \n        max_value=100,\n        help_text=\"Number of results to return (1-100)\"\n\n```\n\n## Imports\n```python\n\"\"\"\nDjango REST Framework serializers for RIA API.\n\nThis module contains all request and response serializers for RIA endpoints.\n\"\"\"\n\nfrom rest_framework import serializers\nfrom typing import List, Dict, Any, Optional\n\n\n# ============================================================================\n# Request Serializers\n# ============================================================================\n\n\n```\n\n\nPlease provide fixes for the above signals using the specified response format."
  },
  "llm_response": [
    "===== FIX FOR: ria/views.py =====\n",
    "CONFIDENCE: 0.95\n",
    "REASONING: Added \"from e\" to the raise statement to properly chain the exception as required by B904\n",
    "\n",
    "```FIXED_CODE\n",
    "    response_serializer = RIAActivitySummaryResponseSerializer(data=response_data)\n",
    "    response_serializer.is_valid()\n",
    "            \n",
    "    return Response(response_serializer.data, status=status.HTTP_200_OK)\n",
    "            \n",
    "except Exception as e:\n",
    "    logger.error(f\"Failed to generate RIA activity summary: {str(e)}\", exc_info=True)\n",
    "    raise APIException(detail=f\"Failed to generate RIA activity summary: {str(e)}\") from e\n",
    "\n",
    "```\n",
    "\n",
    "WARNINGS: None\n",
    "===== END FIX =====\n",
    "\n",
    "===== FIX FOR: authentication/admin.py =====\n",
    "CONFIDENCE: 0.90\n",
    "REASONING: Sorted imports according to isort standards - Django imports first, then local imports\n",
    "\n",
    "```FIXED_CODE\n",
    "from django.contrib import admin\n",
    "from django.contrib.auth.admin import UserAdmin as BaseUserAdmin\n",
    "\n",
    "from .models import User, UserProfile\n",
    "\n",
    "\n",
    "\n",
    "```\n",
    "\n",
    "WARNINGS: None\n",
    "===== END FIX =====\n",
    "\n",
    "===== FIX FOR: ria/serializers.py =====\n",
    "CONFIDENCE: 0.95\n",
    "REASONING: Sorted imports and replaced deprecated typing.List with built-in list type\n",
    "\n",
    "```FIXED_CODE\n",
    "\"\"\"\n",
    "Django REST Framework serializers for RIA API.\n",
    "\n",
    "This module contains all request and response serializers for RIA endpoints.\n",
    "\"\"\"\n",
    "\n",
    "from typing import Any, Dict, Optional\n",
    "\n",
    "from rest_framework import serializers\n",
    "\n",
    "\n",
    "# ============================================================================\n",
    "# Request Serializers\n",
    "# ============================================================================\n",
    "\n",
    "\n",
    "```\n",
    "\n",
    "WARNINGS: None\n",
    "===== END FIX ====="
  ]
}